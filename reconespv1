-- Ultra Optimized Reconstructor ESP
-- FPS-friendly for 100+ models

local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local ReconESP = {}

-- CONFIG
ReconESP.Enabled = true
ReconESP.ShowName = true
ReconESP.ShowDistance = true
ReconESP.ShowOutline = true
ReconESP.TeamCheck = false
ReconESP.DefaultColor = Color3.fromRGB(255,255,255)
ReconESP.FillTransparency = 0.8
ReconESP.OutlineTransparency = 0

-- CACHE
local ActiveESP = {} -- [model] = {Highlight=hl, Tag=gui, LastColor=color}

-- UTILS
local function getReconstructorColor(model)
	local lights = model:FindFirstChild("Lights")
	if not lights then return ReconESP.DefaultColor end
	for _, part in ipairs(lights:GetChildren()) do
		if part:IsA("BasePart") and part.Name == "Part" then
			return part.Color
		end
	end
	return ReconESP.DefaultColor
end

local function getDistanceText(model)
	if not model.PrimaryPart then return "" end
	local camPos = Workspace.CurrentCamera.CFrame.Position
	local dist = (model.PrimaryPart.Position - camPos).Magnitude
	return string.format("[%dm]", math.floor(dist))
end

-- CREATE ESP
local function createESP(model)
	if not model.PrimaryPart or ActiveESP[model] then return end
	local color = ReconESP.TeamCheck and getReconstructorColor(model) or ReconESP.DefaultColor

	local hl = Instance.new("Highlight")
	hl.Name = "ReconESP_HL"
	hl.Adornee = model
	hl.FillColor = color
	hl.OutlineColor = color
	hl.FillTransparency = ReconESP.FillTransparency
	hl.OutlineTransparency = ReconESP.ShowOutline and ReconESP.OutlineTransparency or 1
	hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
	hl.Parent = model

	local gui
	if ReconESP.ShowName or ReconESP.ShowDistance then
		gui = Instance.new("BillboardGui")
		gui.Name = "ReconESP_Tag"
		gui.Adornee = model.PrimaryPart
		gui.Size = UDim2.fromOffset(140,32)
		gui.StudsOffset = Vector3.new(0,3,0)
		gui.AlwaysOnTop = true
		gui.Parent = model.PrimaryPart

		local label = Instance.new("TextLabel")
		label.Size = UDim2.fromScale(1,1)
		label.BackgroundTransparency = 1
		label.TextScaled = true
		label.Font = Enum.Font.Gotham
		label.TextStrokeTransparency = 0.85
		label.TextColor3 = color
		label.Text = ReconESP.ShowName and "Reconstructor" or ""
		label.Parent = gui
	end

	ActiveESP[model] = {Highlight = hl, Tag = gui, LastColor = color}
end

-- REMOVE ESP
local function removeESP(model)
	local data = ActiveESP[model]
	if data then
		if data.Highlight then data.Highlight:Destroy() end
		if data.Tag then data.Tag:Destroy() end
		ActiveESP[model] = nil
	end
end

-- UPDATE ESP (color + distance)
local function updateESP(model)
	local data = ActiveESP[model]
	if not data then return end
	if not model.PrimaryPart then return removeESP(model) end

	local color = ReconESP.TeamCheck and getReconstructorColor(model) or ReconESP.DefaultColor

	-- Atualiza cor só se mudou
	if data.LastColor ~= color then
		data.LastColor = color
		if data.Highlight then
			data.Highlight.FillColor = color
			data.Highlight.OutlineColor = color
			data.Highlight.OutlineTransparency = ReconESP.ShowOutline and ReconESP.OutlineTransparency or 1
		end
		if data.Tag then
			local label = data.Tag:FindFirstChildOfClass("TextLabel")
			if label then
				label.TextColor3 = color
			end
		end
	end

	-- Atualiza distância lentamente
	if data.Tag and ReconESP.ShowDistance then
		local label = data.Tag:FindFirstChildOfClass("TextLabel")
		if label then
			local distTxt = getDistanceText(model)
			label.Text = (ReconESP.ShowName and "Reconstructor " or "")..distTxt
		end
	end
end

-- ================= MAIN LOOP =================

-- 1. Detecta novos Reconstructors a cada 0.5s (rápido, barato)
task.spawn(function()
	while true do
		if ReconESP.Enabled then
			local plots = Workspace:FindFirstChild("Plots")
			if plots then
				for _, recon in ipairs(plots:GetChildren()) do
					if recon:IsA("Model") and recon.Name == "Reconstructor" then
						local lights = recon:FindFirstChild("Lights")
						if lights then
							local hasPart = false
							for _, part in ipairs(lights:GetChildren()) do
								if part:IsA("BasePart") and part.Name == "Part" then
									hasPart = true
									break
								end
							end
							if hasPart then
								if not ActiveESP[recon] then
									createESP(recon)
								end
							else
								removeESP(recon)
							end
						else
							removeESP(recon)
						end
					end
				end
			end
		end
		task.wait(0.5)
	end
end)

-- 2. Atualiza cores/distances via RenderStepped (leve)
RunService.RenderStepped:Connect(function()
	if ReconESP.Enabled then
		for model,_ in pairs(ActiveESP) do
			updateESP(model)
		end
	end
end)

-- ================= API =================

function ReconESP.SetEnabled(v) ReconESP.Enabled = v end
function ReconESP.SetShowName(v) ReconESP.ShowName = v end
function ReconESP.SetShowDistance(v) ReconESP.ShowDistance = v end
function ReconESP.SetShowOutline(v) ReconESP.ShowOutline = v end
function ReconESP.SetTeamCheck(v) ReconESP.TeamCheck = v end
function ReconESP.SetColor(c) ReconESP.DefaultColor = c end

return ReconESP
